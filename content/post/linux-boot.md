+++
Description = ""
Tags = []
date = "2016-09-27T19:51:49+09:00"
title = "Linuxがブートするまで"

+++

普段Linuxを使っていて、`vmlinuz`や`initrd.img`というファイルは何なのか、
BIOSとGRUB Legacyの環境を前提としている。EFIやGRUB2を使った環境については、
今後いずれ勉強していきたい。

基本的にOSの起動は、BIOS -> ブートローダ -> カーネルというように、単純・低機能
なプログラムが、より複雑・高機能なプログラムを読み込み、起動するという処理を
連鎖的に行っていくという仕組みになっている。あくまでブートの大枠を
理解することが目的なので、以下ではブートの各プロセスについてごく簡単に要約して
述べていく。

## 1. BIOS

現在一般的なx86/x64 CPUは、電源投入直後に`0xFFFFFFF0` (Reset Vector) 番地から
実行を開始する。この領域には、BIOSが格納されているマザーボード上のROMがマップ
されている。つまり、電源投入直後からBIOSが実行される。BIOSはハードウェアの検出
や初期化を実行した後、ブートローダを探索する処理に入る。

ブートローダの探索は、優先順位の高いブートデバイスから順に、先頭1セクタの末尾
2バイトが`0x55 0xAA` (Boot Signature) であるか確認することによって行われる。
BIOSは、Boot Signatureが存在するセクタを発見すると、そのセクタを`0x7C00`に
ロードし、実行を移す。

## 2. ブートローダ (GRUB)

ブートローダはOSをディスクからメモリに読み込み、起動するプログラムである。
Linuxでは一般的に[GRand Unified Bootloader
(GRUB)](https://www.gnu.org/software/grub/) というブートローダが用いられる。
GRUBは複数の _Stage_ と呼ばれるプログラムに分かれている。なお、GRUB以外にも、
[Syslinux](http://www.syslinux.org/wiki/index.php?title=The_Syslinux_Project)
や[LILO](https://lilo.alioth.debian.org/)などのブートローダが用いられている。

### Stage 1

ブート可能なディスクの先頭セクタには、[Master Boot Record
(MBR)](https://en.wikipedia.org/wiki/Master_boot_record) が格納されている。MBR
は下記のような構造になっている。

1. ブートローダ (446B)
2. パーティションテーブル (64B)
3. Boot Signature (2B)

GRUBのStage 1は、MBRの先頭446Bに存在する。Stage 1の役割は、Stage 2 (Stage 1.5)
をロードすることである。1セクタしかないMBR内でブートローダの処理を全て実現する
ことが難しいため、このような回りくどい仕組みになっている。

### Stage 1.5

Stage 1.5はの役目は、ディスク上のファイルシステムを解釈し、Stage 2をロードする
ことにある。Stage 1.5は、ディスク上ではMBRと最初のパーティションの間に存在する、
DOS Compatibility Regionという領域に収められている。このStage 1.5は以下の
ように解釈するファイルシステムごとに存在する。

```bash
$ ls -lah /boot/grub | grep stage1_5
-rw-r--r--. 1 root root  14K  3月 13 22:41 2014 e2fs_stage1_5
-rw-r--r--. 1 root root  13K  3月 13 22:41 2014 fat_stage1_5
-rw-r--r--. 1 root root  12K  3月 13 22:41 2014 ffs_stage1_5
-rw-r--r--. 1 root root  12K  3月 13 22:41 2014 iso9660_stage1_5
-rw-r--r--. 1 root root  13K  3月 13 22:41 2014 jfs_stage1_5
-rw-r--r--. 1 root root  12K  3月 13 22:41 2014 minix_stage1_5
-rw-r--r--. 1 root root  15K  3月 13 22:41 2014 reiserfs_stage1_5
-rw-r--r--. 1 root root  12K  3月 13 22:41 2014 ufs2_stage1_5
-rw-r--r--. 1 root root  12K  3月 13 22:41 2014 vstafs_stage1_5
-rw-r--r--. 1 root root  14K  3月 13 22:41 2014 xfs_stage1_5
```

### Stage 2

Stage 2は、GRUBの本体である。これまでのstageでファイルシステムを読み込めるよう
になっているので、stage 2はファイルシステム上にファイルとして置かれている。

```bash
$ ls -lah /boot/grub/stage2
-rw-r--r--. 1 root root 124K  3月 13 22:41 2014 /boot/grub/stage2
```

Stage 2は`menu.lst`というファイルを読み込み、インストールされているOSの
一覧を得る。これを元に、普段目にするOSの選択画面が表示される。下記は、
`menu.lst`の例である。

```nohighlight
# grub.conf generated by anaconda
#
# Note that you do not have to rerun grub after making changes to this file
# NOTICE:  You have a /boot partition.  This means that
#          all kernel and initrd paths are relative to /boot/, eg.
#          root (hd0,0)
#          kernel /vmlinuz-version ro root=/dev/mapper/VolGroup-lv_root
#          initrd /initrd-[generic-]version.img
#boot=/dev/vda
default=0
timeout=5
serial --unit=0 --speed=115200
terminal --timeout=5 serial console
title CentOS (2.6.32-573.18.1.el6.x86_64)
	root (hd0,0)
	kernel /vmlinuz-2.6.32-573.18.1.el6.x86_64 ro root=/dev/mapper/VolGroup-lv_root rd_NO_LUKS LANG=en_US.UTF-8 rd_NO_MD rd_LVM_LV=VolGroup/lv_swap SYSFONT=latarcyrheb-sun16 crashkernel=auto console=ttyS0,115200n8 rd_LVM_LV=VolGroup/lv_root  KEYBOARDTYPE=pc KEYTABLE=us rd_NO_DM
	initrd /initramfs-2.6.32-573.18.1.el6.x86_64.img
title CentOS (2.6.32-573.12.1.el6.x86_64)
	root (hd0,0)
	kernel /vmlinuz-2.6.32-573.12.1.el6.x86_64 ro root=/dev/mapper/VolGroup-lv_root rd_NO_LUKS LANG=en_US.UTF-8 rd_NO_MD rd_LVM_LV=VolGroup/lv_swap SYSFONT=latarcyrheb-sun16 crashkernel=auto console=ttyS0,115200n8 rd_LVM_LV=VolGroup/lv_root  KEYBOARDTYPE=pc KEYTABLE=us rd_NO_DM
	initrd /initramfs-2.6.32-573.12.1.el6.x86_64.img
```

ユーザがどれか1つのOSを選択すると、GRUBはカーネルの実行バイナリ`vmlinuz-*`と
RAMディスク`initramfs-*.img`をメモリ上にロードし、カーネルの先頭アドレスに
ジャンプし、その役目を終える。

## 3. カーネル

ブートローダから起動された`vmlinuz`は、低レベルな初期化処理を実行した後、
カーネルの本体を自己解凍し、メモリにロードする。カーネルの本体の先頭にジャンプ
した後、さらに様々な初期化処理を実行する。ここら辺の仕組みについてより詳しく知
りたい方には、
[linux-insides](https://0xax.gitbooks.io/linux-insides/content/index.html) と
いう資料がおすすめである。また、Linuxではないものの、[30日でできる! OS自作入門
](https://www.amazon.co.jp/dp/4839919844) という書籍もおすすめしたい。

全ての初期化処理が終わると、

```bash
$ gunzip
$ cpio -idv < archive.cpio
```
